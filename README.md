# SOP_CodeGroup53

# Sonar and Flow Sensors - Arduino and MATLAB Codes

## Explanation of Code Files

### Arduino IDE Code

The Arduino code serves as the real-time interface with the physical sensors, responsible for data acquisition and preliminary processing.

* **Sensor Interfacing:** It directly controls and reads data from the **YF-S401 flow sensor** and the **HC-SR04 sonar sensor**. An interrupt is used for the flow sensor to accurately count electrical pulses generated by water flow. For the sonar sensor, it emits ultrasonic pulses and measures the time taken for the echo to return, enabling distance calculation.
* **Data Conversion & Calculation:**
    * From the flow sensor pulses, it calculates the **flow rate** (in liters per minute) and the **total volume** of water that has passed through the system, applying a specific calibration factor (7.5 pulses per liter for the YF-S401).
    * From the sonar sensor's distance measurement, it calculates the **water level** within the container by subtracting the measured distance from the container's total height.
* **Serial Communication:** The calculated values (flow rate, total volume, and water level) are sent to a connected computer via serial communication. The data is formatted as a structured text string, using a pipe (`|`) character as a separator, which facilitates parsing by the MATLAB script. A small delay (100 milliseconds) is included to regulate the data transmission rate.

#### Arduino Code (`arduino_code.ino`)

```arduino
// Define pins for the sonar sensor
const int trigPin = 9;
const int echoPin = 10;

// Define pin for the flow sensor
const int flowPin = 8;

// Variables for sonar sensor
long duration ;
int distance ;
int containerHeight = 30; // has to be changed to a measured real - life value
int waterLevel ;

// Variables for flow sensor
volatile int pulseCount ;
float flowRate ;
unsigned long lastTime ;
float totalVolume ;

// Constants for flow sensor calibration
const float calibrationFactor = 7.5;
const unsigned long reportingInterval = 1000;

void setup () {
// Initialize serial communication
Serial . begin (9600);

// Setup sonar sensor pins
pinMode ( trigPin , OUTPUT );
pinMode ( echoPin , INPUT );

// Setup flow sensor pin
pinMode ( flowPin , INPUT );
attachInterrupt ( digitalPinToInterrupt ( flowPin ) , countPulse , RISING );

// Initialize flow sensor variables
pulseCount = 0;
flowRate = 0.0;
totalVolume = 0.0;
lastTime = millis ();
}

void loop () {
// Measure water level using sonar sensor
measureWaterLevel ();

// Calculate flow rate and volume
calculateFlowRate ();

// Print data to serial port
printData ();

// Delay for a short period
delay (100);
}

void measureWaterLevel () {
// Clear the trigPin by setting it LOW :
digitalWrite ( trigPin , LOW );
delayMicroseconds (2);
// Set the trigPin on HIGH state for 10 micro seconds :
digitalWrite ( trigPin , HIGH );
delayMicroseconds (10);
digitalWrite ( trigPin , LOW );
// Read the echoPin , return the sound wave travel time in microseconds :
duration = pulseIn ( echoPin , HIGH );
// Calculate the distance :
distance = duration * 0.034 / 2;
waterLevel = containerHeight - distance ;
if ( waterLevel < 0) {
waterLevel = 0;
}
}

void countPulse () {
pulseCount ++;
}

void calculateFlowRate () {
unsigned long now = millis ();
if ( now - lastTime >= reportingInterval ) {
// Calculate flow rate in liters per minute
flowRate = ( pulseCount / calibrationFactor ) * (1000.0 / reportingInterval ) * 60;
// Calculate volume in liters
totalVolume += ( pulseCount / calibrationFactor );

lastTime = now ;
pulseCount = 0;
}
}

void printData () {
Serial . print ( flowRate , 2);
Serial . print (" | ");
Serial . print ( totalVolume , 2);
Serial . print (" | ");
Serial . print ( waterLevel );
Serial . println ();
}
